let oldDate,totalDay,availabilitiesMap={},timeslot=0;onSubmit=function(e){let t=$(document.createElement("form"));$(t).attr("action",[null,void 0].includes(e.state)||"draft"!==e.state?formTarget:formTarget+"?draft=true"),$(t).attr("method","POST");var o=$("<input>").attr("type","hidden").attr("name","formioSubmission").val(JSON.stringify(e.data));$(t).append($(o)),t.appendTo(document.body),$(t).submit()},isRdvFormKey=function(e){return e.toUpperCase().includes("RDV")||e.toUpperCase().includes("RENDEZ-VOUS")||e.toUpperCase().includes("RENDEZVOUS")},loadRdv=function(e){Formio.fetch(rdvTarget+"/"+e.key,{headers:{"content-type":"application/json"}}).then((function(t){t.json().then((t=>{if("object"==typeof t.data&&Object.keys(t.data).length>0&&t.success&&t.data.dayTimes&&t.data.dayTimes.length>0){availabilitiesMap[e.key]=t.data.dayTimes.reduce(((e,t)=>{if(0!=Object.values(t).length)return{...e,...t}}));let o=availabilitiesMap[e.key];return totalDay=Object.values(o).length,e.widget.disableWeekends=t.data.disableWeekends||!1,e.disableWeekends=t.data.disableWeekends||!1,e.timePicker.hourStep=0==t.data.step.hour?1:t.data.step.hour,e.widget.hourIncrement=0==t.data.step.hour?1:t.data.step.hour,e.timePicker.minuteStep=0==t.data.step.minute?1:t.data.step.minute,e.widget.minuteIncrement=0==t.data.step.minute?1:t.data.step.minute,e.widget.minDate=(new Date).toISOString(),e.widget.time_24hr=!0,e.widget.disableFunction=`![${Object.keys(o).map((e=>`'${e}'`))}].includes(date.toISOString().split("T")[0]);`,e}}))}))};let options={language:"fr",i18n:{fr:{January:"Janvier",February:"Fevrier",March:"Mars",April:"Avril",May:"Mai",June:"Juin",July:"Juillet",August:"Aout",September:"Septembre",October:"Octobre",November:"Novembre",December:"Decembre","Drop files to attach,":"Glissez-Déposez les fichiers à joindre,",or:"ou",browse:"parcourez","File Name":"Nom du fichier",Size:"Taille","Browse Files":"Parcourir les fichiers","Please fix the following errors before submitting.":"Veuillez corriger les erreurs suivantes avant de soumettre votre demande."}},hooks:{addComponent:(e,t)=>{let o=Formio.Utils.flattenComponents([e]);return Object.values(o).forEach((e=>{isRdvFormKey(e.key)&&"datetime"==e.type&&loadRdv(e,t)})),e}},buttonSettings:{showCancel:!1,showPrevious:!1,showNext:!1,showSubmit:!1}};disableFields=function(e,t=[]){e=JSON.parse(e),components=e.components;let o=[];Formio.Utils.eachComponent(components,((e,i)=>{try{if("button"!==e.type){let a=i.split("."),n=a.length>=2&&t.includes(a.slice(-2)[0]),r=JSON.stringify(e);if(t.includes(e.key)||n){let e=JSON.parse(r);e.disabled=!1,delete e.disabled,r=e}else if(!0!==e.disabled){let e=JSON.parse(r);e.disabled=!0,r=e}else{r=JSON.parse(r)}if(e.disabled!==r.disabled){let t;try{"object"==typeof r&&(t=Formio.Utils.generateFormChange("edit",{originalComponent:e,component:r}))}catch(e){}[null,void 0].includes(t)||o.push(t)}}}catch(e){}}),!1);let i={};return o.length>0&&(i=Formio.Utils.applyFormChanges({components:components},o)),i.form&&i.form.components?i.form:{components:components}},loadSubmission=async function(){try{return submissionSource.includes("record//submission")?{}:Formio.fetch(submissionSource,{headers:{"content-type":"application/json"}}).then((function(e){return e.json().then((e=>e))})).catch((e=>({})))}catch(e){return{}}},b64DecodeUnicode=function(e){return decodeURIComponent(atob(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},window.onload=function(){Formio.clearCache();let e={components:JSON.parse(b64DecodeUnicode(formSource))};(formLabel.toUpperCase().includes("WIZARD")||formTitle.toUpperCase().includes("WIZARD"))&&(e.display="wizard");let t,o=JSON.stringify(e),i={};try{i=JSON.parse(b64DecodeUnicode(submissionSource))}catch(e){}t=i;let a=i&&i.data&&i.data.correctionKeys?i.data.correctionKeys:"";if(["string","object"].includes(typeof a)){try{a=JSON.parse(a)}catch(e){}if("object"==typeof a&&![null,void 0].includes(a)){let i=a[formXref],n=[];if(Array.isArray(i))n=i;else if("string"==typeof i)try{let e=JSON.parse(i);Array.isArray(e)&&(n=e)}catch(e){}e=disableFields(o,n),delete t.data.correctionKeys[formXref]}}return(formLabel.toUpperCase().includes("WIZARD")||formTitle.toUpperCase().includes("WIZARD"))&&(e.display="wizard"),Formio.createForm(document.getElementById("formio"),e,options).then((function(e){let o=!1;function i(){try{let e=localStorage.getItem("service-public"),t=""+formId;if("string"==typeof e&&(e=JSON.parse(e),e.forms&&e.forms[t])){e.forms[t]=void 0,delete e.forms[t];let o=JSON.parse(localStorage.getItem("service-public"));o.forms=e.forms,localStorage.setItem("service-public",JSON.stringify(o))}}catch(e){}}if(t&&(e.submission=t),t&&"object"==typeof t&&Object.keys(t)<=0)try{let t=JSON.parse(localStorage.getItem("service-public")??"{}"),o=""+formId;t&&t.forms&&t.forms[o]&&(e.submission={data:JSON.parse(t.forms[o])})}catch(e){}e.redraw(),o=!0,Object.keys(availabilitiesMap).forEach((t=>{let o=availabilitiesMap[t];if(0!=Object.keys(o).length){const i=e.getComponent(t);let a=Object.keys(o)[0],n=o[a][o[a].length-1];oldDate=a+"T"+n,i.setValue(oldDate)}})),e.on("submit",(function(e){i(),onSubmit(e)})),e.on("change",(function(t,o,i){if(t.changed&&isRdvFormKey(t.changed.component.key)&&t.changed.value&&i&&"datetime"===t.changed.component.type){let o=availabilitiesMap[t.changed.component.key];const i=e.getComponent(t.changed.component.key);let a=0,n=t.changed.value||(new Date).toISOString(),r=new Date(n).getTime()==new Date(oldDate).getTime();a=new Date(n).getTime()>new Date(oldDate).getTime()?1:-1;let s=n.split("T")[0];if(o[s]&&!r){let e=o[s].length,t=timeslot+a;(t>e-1||t<0)&&(t=0);let n=o[s][t];i.setValue(s+"T"+n),oldDate=s+"T"+n,timeslot=t}}try{if(![null,void 0,""].includes(t?.changed?.value)&&i){localStorage.getItem("service-public")||localStorage.setItem("service-public",JSON.stringify({forms:{}}));let t=localStorage.getItem("service-public");t=JSON.parse(t);let o=t.forms??{};o[""+formId]=JSON.stringify(e.data);let i=JSON.parse(localStorage.getItem("service-public"));i.forms=o,localStorage.setItem("service-public",JSON.stringify(i))}}catch(e){}})),e.on("gotoNextPage",(function(){window.scrollTo(0,0),e.nextPage()})),e.on("gotoPreviousPage",(function(){window.scrollTo(0,0),e.prevPage()})),e.on("cancelWizard",(function(){e.resetValue()})),e.on("wizardSave",(function(){i(),e.submit()}));let a=document.getElementsByClassName("formio-component-dateTimeRdv419HH");0!=a.length&&(a[0].className+=" d-none")}))};